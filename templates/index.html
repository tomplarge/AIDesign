<html>
<head>
  <link rel="stylesheet" href="http://code.jquery.com/ui/1.9.2/themes/base/jquery-ui.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <script src="http://d3js.org/d3.v3.min.js"></script>
  <script src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script>
  <script src="http://code.jquery.com/jquery-1.8.3.js"></script>
  <script src="http://code.jquery.com/ui/1.9.2/jquery-ui.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chosen/1.4.2/chosen.jquery.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chosen/1.4.2/chosen.css">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <title>Team Up</title>
  <style type="text/css" media="screen">
  html, body {
    margin: 0;
    height: 100%;
  }
  .wrapper {
    min-height: 100%;

    display: -ms-flexbox;
    display: -webkit-flex;
    display: flex;
    -webkit-flex-flow: row wrap;
    flex-flow: row wrap;
    align-content: flex-start;
  }
  .wrapper > * {
    flex: 1 100%;
  }
  .banner {
    border-bottom-color: black;
    border-bottom-style: solid;
    border-bottom-width: thin;
    list-style: none;
    margin: 0;
    display: -webkit-box;
    display: -moz-box;
    display: -ms-flexbox;
    display: -webkit-flex;
    display: flex;

    -webkit-flex-flow: row wrap;
    justify-content: flex-end;
  }
  .banner a {
    text-decoration: none;
    display: block;
    padding: 1em;
    color: black;
  }
  .banner a:hover {
    background: skyblue;
  }
  .banner li a {
    border: none;
  }
  .banner p {
    left: 20px;
    position: absolute;
  }
  /*.banner-content {
    font-weight: bold;
    font-size: 30;
    color: #002868;
    font-family: "Arial Rounded MT Bold";
    text-align: left;
  }*/
  .content {
    flex: 1;
    border-right-width: thin;
    border-right-color: black;
    border-right-style: solid;
    min-height: 100%;
  }
  .input-pane {

  }
  .input-form {
    font-size: 20px;
  }
  .input-numteams {
    text-align: center;
  }
  .results {
    flex: 2;

    /*display: -webkit-box;
    display: -moz-box;
    display: -ms-flexbox;
    display: -webkit-flex;
    display: flex;*/

    /*-webkit-flex-flow: column;*/
    /*justify-content: space-around;*/
  }
  .team {
    border-color: black;
    border-width: thin;
    border-style: solid;
    padding: 10px;
    margin: 10px;
    min-width: 300px;
    display: flex;
    justify-content: space-around;
    -webkit-flex-flow: row;
    align-items: center;
  }
  .teammates {
    flex: 1;

    display: -webkit-box;
    display: -moz-box;
    display: -ms-flexbox;
    display: -webkit-flex;
    display: flex;

    -webkit-flex-flow: column wrap;
    justify-content: space-around;
    max-height: 200px;
  }
  .team-results {
    background-color: pink;
    flex: 2;
  }
  .teammate {
    height: 40px;
    text-align: center;
    line-height: 40px;
    flex: 1;
    text-align: left;
    padding: 5px;
  }
  .teammate:hover {
    background-color: pink;
  }
  .data {
    border: 1px solid black;
    width: 100px;
  }
  .axis path,
  .axis line {
    fill: none;
    stroke: #000;
    shape-rendering: crispEdges;
  }
  .bar {
    fill: orange;
  }
  .solidArc:hover {
    fill: orangered ;
  }
  /*.solidArc {
      -moz-transition: all 0.3s;
      -o-transition: all 0.3s;
      -webkit-transition: all 0.3s;
      transition: all 0.3s;
  }*/
  .x.axis path {
    display: none;
  }
  .aster-score {
    line-height: 1;
    font-weight: bold;
    font-size: 100%;
  }
  .d3-tip {
    line-height: 1;
    font-weight: bold;
    padding: 12px;
    background: rgba(0, 0, 0, 0.8);
    color: #fff;
    border-radius: 2px;
  }
  /* Creates a small triangle extender for the tooltip */
  .d3-tip:after {
    box-sizing: border-box;
    display: inline;
    font-size: 10px;
    width: 100%;
    line-height: 1;
    color: rgba(0, 0, 0, 0.8);
    content: "\25BC";
    position: absolute;
    text-align: center;
  }
  /* Style northward tooltips differently */
  .d3-tip.n:after {
    margin: -1px 0 0 0;
    top: 100%;
    left: 0;
  }
  </style>
</head>

<body>
  <div class="wrapper">
    <ul class="banner">
        <p>Team Up</p>
        <li><a href="/about">About</a></li>
    </ul>
    <div class="content">
      <div class="input-pane">
        <!-- <script>
        function onNumTeamsChange() {
          var context = '{{context}}';
          console.log(context);
          var numTeams = document.getElementById('numteams').value;
          var results = document.getElementsByClassName("results")[0];
          // remove elements
          while (results.firstChild) {
              results.removeChild(results.firstChild);
          }
          // add numTeams elements
          for (var i = 0; i < numTeams; i++) {
            var teamDiv = document.createElement("div");
            teamDiv.classList.add('team');
            results.appendChild(teamDiv);
          }
        }
        </script> -->
        <script type="text/javascript">
        $(function() {
            $(".chzn-select").chosen();
            var features = {{features|safe}}
            $('.chzn-select').val(features);
            $('.chzn-select').trigger("chosen:updated");

            var numteams = {{request.args.get('numteams')}}
            if (numteams){
              $(".input-numteams").val(numteams);
            }
            else {
              $(".input-numteams").val(1);
            }

        });
        </script>

        <form class="input-form" action="/" method="get">
          Class Name:
          <input type="text" name="classname"><br><br>
          Number of Teams:
          <input class = "input-numteams" type="number" name="numteams" id="numteams" min="1"><br><br>
          Traits:
          <select class="chzn-select" multiple="true" name="features" style="width:200px;" data-placeholder="Select Features">
            <optgroup label="Needs">
              <option value="need_challenge">Challenge</option>
              <option value="need_closeness">Closeness</option>
              <option value="need_curiosity">Curiosity</option>
              <option value="need_excitement">Excitement</option>
              <option value="need_harmony">Harmony</option>
              <option value="need_ideal">Ideal</option>
              <option value="need_liberty">Liberty</option>
              <option value="need_love">Love</option>
              <option value="need_practicality">Practicality</option>
              <option value="need_self_expression">Self-expression</option>
              <option value="need_stability">Stability</option>
              <option value="need_structure">Structure</option>
            </optgroup>
            <optgroup label="Values">
              <option value="value_conservation">Conservation</option>
              <option value="value_openness_to_change">Openness to change</option>
              <option value="value_hedonism">Hedonism</option>
              <option value="value_self_enhancement">Self-enhancement</option>
              <option value="value_self_transcendence">Self-transcendence</option>
            </optgroup>
            <optgroup label="Emotional Range">
              <option value="facet_anger">Fiery</option>
              <option value="facet_anxiety">Prone to worry</option>
              <option value="facet_depression">Melancholy</option>
              <option value="facet_immoderation">Immoderation</option>
              <option value="facet_self_consciousness">Self-consciousness</option>
              <option value="facet_vulnerability">Susceptible to stress</option>
            </optgroup>
            <optgroup label="Openness">
              <option value="facet_adventurousness">Adventurousness</option>
              <option value="facet_artistic_interests">Artistic interests</option>
              <option value="facet_emotionality">Emotionality</option>
              <option value="facet_imagination">Imagination</option>
              <option value="facet_intellect">Intellect</option>
              <option value="facet_liberalism">Authority-challenging</option>
            </optgroup>
            <optgroup label="Extraversion">
              <option value="facet_activity_level">Activity level</option>
              <option value="facet_assertiveness">Assertiveness</option>
              <option value="facet_cheerfulness">Cheerfulness</option>
              <option value="facet_excitement_seeking">Excitement-seeking</option>
              <option value="facet_friendliness">Outgoing</option>
              <option value="facet_gregariousness">Gregariousness</option>
            </optgroup>
            <optgroup label="Agreeableness">
              <option value="facet_altruism">Altruism</option>
              <option value="facet_cooperation">Cooperation</option>
              <option value="facet_modesty">Modesty</option>
              <option value="facet_morality">Uncompromising</option>
              <option value="facet_sympathy">Sympathy</option>
              <option value="facet_trust">Trust</option>
            </optgroup>
            <optgroup label="Conscientiousness">
              <option value="facet_achievement_striving">Achievement striving</option>
              <option value="facet_cautiousness">Cautiousness</option>
              <option value="facet_dutifulness">Dutifulness</option>
              <option value="facet_orderliness">Orderliness</option>
              <option value="facet_self_discipline">Self-discipline</option>
              <option value="facet_self_efficacy">Self-efficacy</option>
            </optgroup>
          </select><br><br>
          <input type="submit" name="run" value="Run">
        </form>
      </div>
    </div>
    <div class="results">
      {% for team in teams %}
      {% set outer_loop = loop %}
      <div id = "team{{loop.index0}}" class="team">
        <div class="teammates">
          {% for teammate in team %}
            <div class="teammate" id="{{outer_loop.index0}}-{{loop.index0}}"=>{{teammate['name']}}</div>
          {% endfor %}
        </div>
      </div>
      {% endfor %}
    </div>
    <script>
    // var traits_json = (function () {
    //     var json = null;
    //     $.ajax({
    //         'async': false,
    //         'global': false,
    //         'url': 'http://localhost:5000/static/traits.json',
    //         'dataType': "json",
    //         'success': function (data) {
    //             json = data;
    //         }
    //     });
    //     return json;
    // })();
    var traits_json = {
      "facet_cautiousness": {
        "color": "#1E54C9",
        "label": "Cautiousness"
      },
      "facet_self_efficacy": {
        "color": "#1E54C9",
        "label": "Self-efficacy"
      },
      "need_liberty": {
        "color": "#6F2DBD",
        "label": "Liberty"
      },
      "facet_adventurousness": {
        "color": "#018E42",
        "label": "Adventurousness"
      },
      "need_challenge": {
        "color": "#6F2DBD",
        "label": "Challenge"
      },
      "facet_cooperation": {
        "color": "#E86806",
        "label": "Cooperation"
      },
      "facet_sympathy": {
        "color": "#E86806",
        "label": "Sympathy"
      },
      "facet_self_discipline": {
        "color": "#1E54C9",
        "label": "Self-discipline"
      },
      "need_harmony": {
        "color": "#6F2DBD",
        "label": "Harmony"
      },
      "facet_morality": {
        "color": "#E86806",
        "label": "Uncompromising"
      },
      "facet_liberalism": {
        "color": "#018E42",
        "label": "Authority-challenging"
      },
      "facet_altruism": {
        "color": "#E86806",
        "label": "Altruism"
      },
      "facet_friendliness": {
        "color": "#F7D002",
        "label": "Outgoing"
      },
      "need_love": {
        "color": "#6F2DBD",
        "label": "Love"
      },
      "facet_activity_level": {
        "color": "#F7D002",
        "label": "Activity level"
      },
      "facet_anxiety": {
        "color": "#F00699",
        "label": "Prone to worry"
      },
      "need_self_expression": {
        "color": "#6F2DBD",
        "label": "Self-expression"
      },
      "facet_emotionality": {
        "color": "#018E42",
        "label": "Emotionality"
      },
      "need_curiosity": {
        "color": "#6F2DBD",
        "label": "Curiosity"
      },
      "facet_vulnerability": {
        "color": "#F00699",
        "label": "Susceptible to stress"
      },
      "need_excitement": {
        "color": "#6F2DBD",
        "label": "Excitement"
      },
      "facet_excitement_seeking": {
        "color": "#F7D002",
        "label": "Excitement-seeking"
      },
      "facet_self_consciousness": {
        "color": "#F00699",
        "label": "Self-consciousness"
      },
      "facet_cheerfulness": {
        "color": "#F7D002",
        "label": "Cheerfulness"
      },
      "facet_depression": {
        "color": "#F00699",
        "label": "Melancholy"
      },
      "value_hedonism": {
        "color": "#BF1A2F",
        "label": "Hedonism"
      },
      "value_openness_to_change": {
        "color": "#BF1A2F",
        "label": "Openness to change"
      },
      "facet_imagination": {
        "color": "#018E42",
        "label": "Imagination"
      },
      "value_conservation": {
        "color": "#BF1A2F",
        "label": "Conservation"
      },
      "need_ideal": {
        "color": "#6F2DBD",
        "label": "Ideal"
      },
      "need_practicality": {
        "color": "#6F2DBD",
        "label": "Practicality"
      },
      "facet_trust": {
        "color": "#E86806",
        "label": "Trust"
      },
      "facet_anger": {
        "color": "#F00699",
        "label": "Fiery"
      },
      "facet_gregariousness": {
        "color": "#F7D002",
        "label": "Gregariousness"
      },
      "facet_artistic_interests": {
        "color": "#018E42",
        "label": "Artistic interests"
      },
      "facet_assertiveness": {
        "color": "#F7D002",
        "label": "Assertiveness"
      },
      "facet_intellect": {
        "color": "#018E42",
        "label": "Intellect"
      },
      "facet_immoderation": {
        "color": "#F00699",
        "label": "Immoderation"
      },
      "facet_orderliness": {
        "color": "#1E54C9",
        "label": "Orderliness"
      },
      "need_stability": {
        "color": "#6F2DBD",
        "label": "Stability"
      },
      "facet_modesty": {
        "color": "#E86806",
        "label": "Modesty"
      },
      "value_self_enhancement": {
        "color": "#BF1A2F",
        "label": "Self-enhancement"
      },
      "value_self_transcendence": {
        "color": "#BF1A2F",
        "label": "Self-transcendence"
      },
      "facet_achievement_striving": {
        "color": "#1E54C9",
        "label": "Achievement striving"
      },
      "facet_dutifulness": {
        "color": "#1E54C9",
        "label": "Dutifulness"
      },
      "need_structure": {
        "color": "#6F2DBD",
        "label": "Structure"
      },
      "need_closeness": {
        "color": "#6F2DBD",
        "label": "Closeness"
      }
    };
    var teams = {{teams|tojson}}
    var features = {{features|safe}}
    teams.forEach(function(team, team_idx) {
      var width = 200,
          height = 200,
          radius = Math.min(width, height) / 2,
          innerRadius = 0 * radius;

      var pie = d3.layout.pie()
          .sort(null)
          .value(function(d) { return 1; });

      var tip = d3.tip()
        .attr('class', 'd3-tip')
        .offset([0, 0])
        .html(function(d) {
          return d.data.label + ": <span style='color:orangered'>" + d.data.score + "</span>";
        });

      var arcBackground = d3.svg.arc()
        .innerRadius(innerRadius)
        .outerRadius(function (d) {
          return (radius - innerRadius) * (100 / 100.0) + innerRadius;

        });

      var arc = d3.svg.arc()
        .innerRadius(innerRadius)
        .outerRadius(function (d) {
          return (radius - innerRadius) * (d.data.score / 100.0) + innerRadius;

        });

      var outlineArc = d3.svg.arc()
              .innerRadius(innerRadius)
              .outerRadius(radius)

      var svg = d3.selectAll("div.team#team"+team_idx).append("svg")
          .attr("width", width)
          .attr("height", height)
          .append("g")
          .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

      svg.call(tip);

      var data = [];

      for (var feat_idx = 0; feat_idx < features.length; feat_idx++) {
        var d = {}
        var feat = features[feat_idx];
        d.label = traits_json[feat].label;
        d.color = traits_json[feat].color;
        d.feat = feat;
        d.weight = 1;
        d.score = 0;
        for (var p_idx = 0; p_idx < team.length; p_idx++) {
          var p = team[p_idx];
          // set value of arc to max value in team
          if (p[feat] > d.score)
            d.score = p[feat];
        }

        d.score = Math.round(d.score * 100);
        data.push(d);
      }

      var p_data = [];
      for (var p_idx = 0; p_idx < team.length; p_idx++) {
        var temp_data = [];
        for (var feat_idx = 0; feat_idx < features.length; feat_idx++) {
          var d = {}
          var feat = features[feat_idx];
          d.label = traits_json[feat].label;
          d.color = traits_json[feat].color;
          d.feat = feat;
          d.weight = 1;
          d.score = team[p_idx][feat];
          d.score = Math.round(d.score * 100);
          temp_data.push(d);
        }
        p_data.push(temp_data);
      }

      var path = svg.selectAll(".solidArc")
          .data(pie(data))
        .enter().append("path")
          .attr("fill", function(d) {return d.data.color; })
          .attr("class", "solidArc")
          .attr("stroke", "gray")
          .attr("d", arc)

      for (var p_idx = 0; p_idx < p_data.length; p_idx++) {
        var path = svg.selectAll(".outlineArc"+p_idx)
            .data(pie(p_data[p_idx]))
          .enter().append("path")
            .attr("fill", 'transparent')
            .attr("class", "outlineArc"+p_idx)
            .attr("id", team_idx+"-"+p_idx)
            .attr("stroke", "transparent")
            .attr("stroke-width", 2)
            .attr("d", arc)

        $("#"+team_idx+"-"+p_idx).mouseover(function(e){
          var split = this.id.split("-");
          var team_idx = split[0];
          var p_idx = split[1];
          $("#"+team_idx+"-"+p_idx+".outlinearc"+p_idx).attr({'stroke':'white', 'fill':"rgba(0,0,0,0.5)"})
        });
        $("#"+team_idx+"-"+p_idx).mouseout(function(e){
          var split = this.id.split("-");
          var team_idx = split[0];
          var p_idx = split[1];
          $("#"+team_idx+"-"+p_idx+".outlinearc"+p_idx).attr({'stroke':'transparent', 'fill':'transparent'})
        });
        // $("#"+team_idx+"-"+p_idx).click(function(e){
        //   var split = this.id.split("-");
        //   var team_idx = split[0];
        //   var p_idx = split[1];
        //   $("#"+team_idx+"-"+p_idx+".outlinearc"+p_idx).attr({'stroke','#7FEFBD', 'fill':'#7FEFBD'})
        // });
      }

      var outerPath = svg.selectAll(".outlineArc")
          .data(pie(data))
        .enter().append("path")
          .attr("fill", "none")
          .attr("stroke", "gray")
          .attr("class", "outlineArc")
          .attr("d", outlineArc)

      var pathBackground = svg.selectAll(".arcBackground")
          .data(pie(data))
        .enter().append("path")
          .attr("fill", 'transparent')
          .attr("d", arcBackground)
          .on('mouseover', tip.show)
          .on('mouseout', tip.hide);
      // calculate the weighted mean score
      // var score =
      //   data.reduce(function(a, b) {
      //     //console.log('a:' + a + ', b.score: ' + b.score + ', b.weight: ' + b.weight);
      //     return a + (b.score * b.weight);
      //   }, 0) /
      //   data.reduce(function(a, b) {
      //     return a + b.weight;
      //   }, 0);

      // svg.append("svg:text")
      //   .attr("class", "aster-score")
      //   .attr("dy", ".35em")
      //   .attr("text-anchor", "middle") // text-align: right
      //   .text(Math.round(score));
      }
    );
    </script>
</body>
</html>
